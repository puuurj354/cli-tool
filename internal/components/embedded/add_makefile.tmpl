# =============================================================================
# Makefile for Go Projects
# =============================================================================
# TODO: Customize the following:
#   - BINARY_NAME: Your application binary name
#   - MAIN_PATH: Path to your main.go
#   - Add additional targets as needed

BINARY_NAME := app
MAIN_PATH := ./cmd/server
GO := go
GOFLAGS := -v

# Build info
VERSION := $(shell git describe --tags --always --dirty 2>/dev/null || echo "dev")
BUILD_TIME := $(shell date -u '+%Y-%m-%d_%H:%M:%S')
LDFLAGS := -ldflags "-X main.version=$(VERSION) -X main.buildTime=$(BUILD_TIME)"

.PHONY: all build run test lint clean help

## help: Show this help message
help:
	@echo "Available targets:"
	@sed -n 's/^##//p' $(MAKEFILE_LIST) | column -t -s ':' | sed -e 's/^/ /'

## all: Build and test
all: lint test build

## build: Build the binary
build:
	$(GO) build $(GOFLAGS) $(LDFLAGS) -o $(BINARY_NAME) $(MAIN_PATH)

## run: Run the application
run:
	$(GO) run $(MAIN_PATH)

## test: Run tests
test:
	$(GO) test ./... -v -cover

## test-short: Run short tests only
test-short:
	$(GO) test ./... -short

## bench: Run benchmarks
bench:
	$(GO) test ./... -bench=. -benchmem

## lint: Run linters
lint:
	@command -v golangci-lint >/dev/null 2>&1 || { echo "Installing golangci-lint..."; go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest; }
	golangci-lint run ./...

## fmt: Format code
fmt:
	$(GO) fmt ./...
	@command -v goimports >/dev/null 2>&1 && goimports -w . || true

## tidy: Tidy go modules
tidy:
	$(GO) mod tidy

## clean: Remove build artifacts
clean:
	rm -f $(BINARY_NAME)
	$(GO) clean -cache

## docker-build: Build Docker image
docker-build:
	docker build -t $(BINARY_NAME):$(VERSION) .

## docker-run: Run Docker container
docker-run: docker-build
	docker run --rm -p 8080:8080 $(BINARY_NAME):$(VERSION)
